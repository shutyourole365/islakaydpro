name: SQL Security Check

on:
  pull_request:
    paths:
      - 'supabase/migrations/**/*.sql'
      - '**/*.sql'
  push:
    branches: [main]
    paths:
      - 'supabase/migrations/**/*.sql'
      - '**/*.sql'

jobs:
  sql-security:
    name: SQL Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for SQL injection patterns
        run: |
          echo "ğŸ” Checking SQL files for security issues..."
          
          # Check for potential SQL injection vulnerabilities
          if grep -r -E "(exec|execute|eval)\s*\(" supabase/migrations/ 2>/dev/null; then
            echo "âš ï¸  Warning: Found potentially unsafe SQL execution patterns"
            echo "Please review these patterns for SQL injection vulnerabilities"
          else
            echo "âœ… No obvious SQL injection patterns found"
          fi
          
          # Check for commented credentials
          if grep -r -i -E "(password|secret|api_key|token)\s*=" supabase/migrations/ 2>/dev/null | grep -v "REDACTED"; then
            echo "âŒ ERROR: Found potential credentials in SQL files"
            exit 1
          else
            echo "âœ… No hardcoded credentials found"
          fi
          
          # Check for DROP DATABASE or DROP SCHEMA
          if grep -r -i "DROP\s\+\(DATABASE\|SCHEMA\)" supabase/migrations/ 2>/dev/null; then
            echo "âš ï¸  Warning: Found DROP DATABASE/SCHEMA statements"
            echo "Please ensure these are intentional"
          fi
          
          echo "âœ… SQL security check completed successfully"

      - name: Validate SQL syntax (basic)
        run: |
          echo "ğŸ” Validating SQL syntax..."
          
          # Check for balanced parentheses
          for file in $(find supabase/migrations -name "*.sql" 2>/dev/null); do
            echo "Checking $file..."
            
            # Count opening and closing parentheses
            open=$(grep -o "(" "$file" | wc -l)
            close=$(grep -o ")" "$file" | wc -l)
            
            if [ "$open" -ne "$close" ]; then
              echo "âš ï¸  Warning: Unbalanced parentheses in $file"
            fi
          done
          
          echo "âœ… SQL syntax validation completed"

      - name: Check for RLS policies
        run: |
          echo "ğŸ” Checking for Row Level Security policies..."
          
          # Check if RLS is enabled on tables
          if grep -r "CREATE TABLE" supabase/migrations/ 2>/dev/null | grep -v "CREATE TABLE IF NOT EXISTS"; then
            echo "âš ï¸  Warning: Some tables may not use IF NOT EXISTS"
          fi
          
          # Check for ALTER TABLE ENABLE RLS
          if grep -r "ALTER TABLE.*ENABLE ROW LEVEL SECURITY" supabase/migrations/ 2>/dev/null; then
            echo "âœ… Found RLS enablement statements"
          else
            echo "âš ï¸  Warning: No RLS policies found in migrations"
          fi
          
          echo "âœ… RLS check completed"

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… SQL Security Analysis Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "All SQL security checks passed!"
          echo "Your database migrations are secure."
          echo ""
